{"version":3,"file":"auth.js","names":["express","require","jwt","router","Router","verifyJWT","ApiError","ApiResponse","asyncHandler","Admin","generateAccessAndRefereshTokens","adminId","admin","findById","accessToken","generateAccessToken","refreshToken","generateRefreshToken","save","validateBeforeSave","error","registerAdmin","req","res","email","password","body","some","field","trim","existedAdmin","findOne","$or","create","createdAdmin","_id","select","status","json","loginAdmin","console","log","isPasswordValid","isPasswordCorrect","loggedInAdmin","options","httpOnly","secure","cookie","logoutAdmin","findByIdAndUpdate","$unset","new","clearCookie","refreshAccessToken","incomingRefreshToken","cookies","decodedToken","verify","process","env","REFRESH_TOKEN_SECRET","newRefreshToken","message","route","post","module","exports"],"sources":["../../../../src/admin/routes/auth/auth.js"],"sourcesContent":["const express = require(\"express\");\nconst jwt = require(\"jsonwebtoken\");\nconst router = express.Router();\nconst verifyJWT = require(\"../../middleware/verifyJwt\");\nconst ApiError = require(\"../../utils/apiError\");\nconst ApiResponse = require(\"../../utils/apiResponse\");\nconst asyncHandler = require(\"../../utils/asyncHandler\");\nconst Admin = require(\"../../models/admin\");\nconst generateAccessAndRefereshTokens = async (adminId) => {\n\ttry {\n\t\tconst admin = await Admin.findById(adminId);\n\t\tconst accessToken = admin.generateAccessToken();\n\t\tconst refreshToken = admin.generateRefreshToken();\n\n\t\tadmin.refreshToken = refreshToken;\n\t\tawait admin.save({ validateBeforeSave: false });\n\n\t\treturn { accessToken, refreshToken };\n\t} catch (error) {\n\t\tthrow new ApiError(\n\t\t\t500,\n\t\t\t\"Something went wrong while generating referesh and access token\"\n\t\t);\n\t}\n};\n\nconst registerAdmin = asyncHandler(async (req, res) => {\n\tconst { email, password } = req.body;\n\t//console.log(\"email: \", email);\n\n\tif ([email, password].some((field) => field?.trim() === \"\")) {\n\t\tthrow new ApiError(400, \"All fields are required\");\n\t}\n\n\tconst existedAdmin = await Admin.findOne({\n\t\t$or: [{ email }],\n\t});\n\n\tif (existedAdmin) {\n\t\tthrow new ApiError(409, \"Admin already exists\");\n\t}\n\t//console.log(req.files);\n\n\tconst admin = await Admin.create({\n\t\temail: email,\n\t\tpassword: password,\n\t});\n\n\tconst createdAdmin = await Admin.findById(admin._id).select(\n\t\t\"-password -refreshToken\"\n\t);\n\n\tif (!createdAdmin) {\n\t\tthrow new ApiError(\n\t\t\t500,\n\t\t\t\"Something went wrong while registering the Admin\"\n\t\t);\n\t}\n\n\treturn res\n\t\t.status(201)\n\t\t.json(\n\t\t\tnew ApiResponse(\n\t\t\t\t200,\n\t\t\t\tcreatedAdmin,\n\t\t\t\t\"Admin registered Successfully\"\n\t\t\t)\n\t\t);\n});\n\nconst loginAdmin = asyncHandler(async (req, res) => {\n\tconst { email, password } = req.body;\n\tconsole.log(email);\n\n\tif (!email) {\n\t\tthrow new ApiError(400, \"email is required\");\n\t}\n\tconst admin = await Admin.findOne({\n\t\temail: email,\n\t});\n\n\tif (!admin) {\n\t\tthrow new ApiError(404, \"Admin does not exist\");\n\t}\n\n\tconst isPasswordValid = await admin.isPasswordCorrect(password);\n\n\tif (!isPasswordValid) {\n\t\tthrow new ApiError(401, \"Invalid admin credentials\");\n\t}\n\n\tconst { accessToken, refreshToken } =\n\t\tawait generateAccessAndRefereshTokens(admin._id);\n\n\tconst loggedInAdmin = await Admin.findById(admin._id).select(\n\t\t\"-password -refreshToken\"\n\t);\n\n\tconst options = {\n\t\thttpOnly: true,\n\t\tsecure: true,\n\t};\n\n\treturn res\n\t\t.status(200)\n\t\t.cookie(\"accessToken\", accessToken, options)\n\t\t.cookie(\"refreshToken\", refreshToken, options)\n\t\t.json(\n\t\t\tnew ApiResponse(\n\t\t\t\t200,\n\t\t\t\t{\n\t\t\t\t\tadmin: loggedInAdmin,\n\t\t\t\t\taccessToken,\n\t\t\t\t\trefreshToken,\n\t\t\t\t},\n\t\t\t\t\"Admin logged In Successfully\"\n\t\t\t)\n\t\t);\n});\n\nconst logoutAdmin = asyncHandler(async (req, res) => {\n\tawait Admin.findByIdAndUpdate(\n\t\treq.admin._id,\n\t\t{\n\t\t\t$unset: {\n\t\t\t\trefreshToken: 1, // this removes the field from document\n\t\t\t},\n\t\t},\n\t\t{\n\t\t\tnew: true,\n\t\t}\n\t);\n\n\tconst options = {\n\t\thttpOnly: true,\n\t\tsecure: true,\n\t};\n\n\treturn res\n\t\t.status(200)\n\t\t.clearCookie(\"accessToken\", options)\n\t\t.clearCookie(\"refreshToken\", options)\n\t\t.json(new ApiResponse(200, {}, \"Admin logged Out\"));\n});\n\nconst refreshAccessToken = asyncHandler(async (req, res) => {\n\tconst incomingRefreshToken =\n\t\treq.cookies.refreshToken || req.body.refreshToken;\n\n\tif (!incomingRefreshToken) {\n\t\tthrow new ApiError(401, \"unauthorized request\");\n\t}\n\n\ttry {\n\t\tconst decodedToken = jwt.verify(\n\t\t\tincomingRefreshToken,\n\t\t\tprocess.env.REFRESH_TOKEN_SECRET\n\t\t);\n\n\t\tconst admin = await Admin.findById(decodedToken?._id);\n\n\t\tif (!admin) {\n\t\t\tthrow new ApiError(401, \"Invalid refresh token\");\n\t\t}\n\n\t\tif (incomingRefreshToken !== admin?.refreshToken) {\n\t\t\tthrow new ApiError(401, \"Refresh token is expired or used\");\n\t\t}\n\n\t\tconst options = {\n\t\t\thttpOnly: true,\n\t\t\tsecure: true,\n\t\t};\n\n\t\tconst { accessToken, newRefreshToken } =\n\t\t\tawait generateAccessAndRefereshTokens(admin._id);\n\n\t\treturn res\n\t\t\t.status(200)\n\t\t\t.cookie(\"accessToken\", accessToken, options)\n\t\t\t.cookie(\"refreshToken\", newRefreshToken, options)\n\t\t\t.json(\n\t\t\t\tnew ApiResponse(\n\t\t\t\t\t200,\n\t\t\t\t\t{ accessToken, refreshToken: newRefreshToken },\n\t\t\t\t\t\"Access token refreshed\"\n\t\t\t\t)\n\t\t\t);\n\t} catch (error) {\n\t\tthrow new ApiError(\n\t\t\t401,\n\t\t\terror?.message || \"Invalid refresh token\"\n\t\t);\n\t}\n});\n\n// Register route\nrouter.route(\"/register\").post(registerAdmin);\n// Login route\nrouter.route(\"/login\").post(loginAdmin);\n//Logout\nrouter.route(\"/logout\").post(verifyJWT, logoutAdmin);\n\nrouter.route(\"/refresh-token\").post(refreshAccessToken);\n\nmodule.exports = router;\n"],"mappings":"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","ignoreList":[]}