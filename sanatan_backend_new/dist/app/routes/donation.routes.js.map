{"version":3,"file":"donation.routes.js","names":["express","require","router","Router","Donation","DonationContent","asyncHandler","verifyJWT","ObjectId","ApiResponse","default","mongoose","Invoice","currentDate","Date","getActiveContentsByLangId","req","res","langid","params","contents","aggregate","$match","status","$or","publish","$lt","$addFields","availableLanguages","$map","input","$filter","$objectToArray","cond","$and","$eq","as","in","$expr","$gt","$size","availableLanguage","$cond","$in","$first","$lookup","from","localField","foreignField","favr","if","user","_id","Types","then","else","let","pipeline","json","error","message","makeDonationInvoice","invoice","donationId","body","userId","amount","paymentType","newInvoice","save","err","getUserInvoices","invoices","find","getDonationContent","id","Page","route","get","post","module","exports"],"sources":["../../../src/app/routes/donation.routes.js"],"sourcesContent":["const express = require(\"express\");\nconst router = express.Router();\nconst Donation = require(\"../../admin/models/donation.page\");\nconst DonationContent = require(\"../../admin/models/donation\");\nconst asyncHandler = require(\"../utils/asyncHandler\");\nconst verifyJWT = require(\"../middleware/verifyjwt\");\nconst { ObjectId } = require(\"mongodb\");\nconst ApiResponse = require(\"../utils/apiresponse\");\nconst { default: mongoose } = require(\"mongoose\");\nconst Invoice = require(\"../models/users/invoice\");\nconst currentDate = new Date();\nconst getActiveContentsByLangId = asyncHandler(async (req, res) => {\n\tconst langid = req.params.langid;\n\n\ttry {\n\t\tconst currentDate = new Date(); // Ensure currentDate is defined\n\n\t\tconst contents = await Donation.aggregate([\n\t\t\t{\n\t\t\t\t$match: {\n\t\t\t\t\tstatus: \"STATUS_ACTIVE\",\n\t\t\t\t\t$or: [{ publish: { $lt: currentDate } }, { publish: null }],\n\t\t\t\t},\n\t\t\t},\n\n\t\t\t{\n\t\t\t\t$addFields: {\n\t\t\t\t\tavailableLanguages: {\n\t\t\t\t\t\t$map: {\n\t\t\t\t\t\t\tinput: {\n\t\t\t\t\t\t\t\t$filter: {\n\t\t\t\t\t\t\t\t\tinput: { $objectToArray: \"$Availability\" },\n\t\t\t\t\t\t\t\t\tcond: {\n\t\t\t\t\t\t\t\t\t\t$and: [\n\t\t\t\t\t\t\t\t\t\t\t{ $eq: [\"$$this.v.checked\", true] },\n\t\t\t\t\t\t\t\t\t\t\t{ $eq: [\"$$this.v.value\", \"Available\"] },\n\t\t\t\t\t\t\t\t\t\t],\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tas: \"lang\",\n\t\t\t\t\t\t\tin: \"$$lang.k\", // Extract the language key\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t\t{\n\t\t\t\t$match: {\n\t\t\t\t\t$expr: { $gt: [{ $size: \"$availableLanguages\" }, 0] },\n\t\t\t\t},\n\t\t\t},\n\t\t\t{\n\t\t\t\t$addFields: {\n\t\t\t\t\tavailableLanguage: {\n\t\t\t\t\t\t$cond: [\n\t\t\t\t\t\t\t{ $in: [langid, \"$availableLanguages\"] },\n\t\t\t\t\t\t\tlangid,\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t$cond: [\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t$in: [\"$defaultLanguage\", \"$availableLanguages\"],\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\"$defaultLanguage\",\n\t\t\t\t\t\t\t\t\t{ $first: \"$availableLanguages\" },\n\t\t\t\t\t\t\t\t],\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t],\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t\t{\n\t\t\t\t$lookup: {\n\t\t\t\t\tfrom: \"wishlists\",\n\t\t\t\t\tlocalField: \"_id\",\n\t\t\t\t\tforeignField: \"item\",\n\t\t\t\t\tas: \"favr\",\n\t\t\t\t},\n\t\t\t},\n\t\t\t{\n\t\t\t\t$addFields: {\n\t\t\t\t\tfavr: {\n\t\t\t\t\t\t$cond: {\n\t\t\t\t\t\t\tif: {\n\t\t\t\t\t\t\t\t$in: [\n\t\t\t\t\t\t\t\t\treq.user?._id\n\t\t\t\t\t\t\t\t\t\t? new mongoose.Types.ObjectId(req.user._id)\n\t\t\t\t\t\t\t\t\t\t: null,\n\t\t\t\t\t\t\t\t\t\"$favr.user\",\n\t\t\t\t\t\t\t\t],\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tthen: true,\n\t\t\t\t\t\t\telse: false,\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t\t{\n\t\t\t\t$lookup: {\n\t\t\t\t\tfrom: \"donationcontents\",\n\t\t\t\t\tlocalField: \"_id\",\n\t\t\t\t\tforeignField: \"Page\",\n\t\t\t\t\tas: \"content\",\n\t\t\t\t\tlet: { availableLanguage: \"$availableLanguage\" },\n\t\t\t\t\tpipeline: [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$match: {\n\t\t\t\t\t\t\t\t$expr: { $eq: [\"$Language\", \"$$availableLanguage\"] }, // Use the variable in the match condition\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t],\n\t\t\t\t},\n\t\t\t},\n\t\t]);\n\n\t\tres.status(200).json(\n\t\t\tnew ApiResponse(\n\t\t\t\t200,\n\t\t\t\t{\n\t\t\t\t\tcontents,\n\t\t\t\t},\n\t\t\t\t\"Pages fetched Successfully\"\n\t\t\t)\n\t\t);\n\t} catch (error) {\n\t\tres.status(500).json({ message: error.message });\n\t}\n});\n\nconst makeDonationInvoice = asyncHandler(async (req, res) => {\n\tconst invoice = new Invoice({\n\t\tstatus: \"SUCCESS\",\n\t\tdonationId: req.body.donationId,\n\t\tuser: req.body.userId,\n\t\tamount: req.body.amount,\n\t\tpaymentType: req.body.paymentType,\n\t});\n\ttry {\n\t\tconst newInvoice = await invoice.save();\n\t\tres.status(200).json(newInvoice);\n\t} catch (err) {\n\t\tres.status(400).json({ message: err.message });\n\t}\n});\nconst getUserInvoices = asyncHandler(async (req, res) => {\n\ttry {\n\t\tconst invoices = await Invoice.find({\n\t\t\tuser: req.user._id,\n\t\t});\n\t\tres.status(200).json(invoices);\n\t} catch (err) {\n\t\tres.status(400).json({ message: err.message });\n\t}\n});\n\nconst getDonationContent = asyncHandler(async (req, res) => {\n\ttry {\n\t\tconst contents = await DonationContent.aggregate([\n\t\t\t{\n\t\t\t\t$match: {\n\t\t\t\t\t_id: new mongoose.Types.ObjectId(req.params.id),\n\t\t\t\t},\n\t\t\t},\n\t\t\t{\n\t\t\t\t$lookup: {\n\t\t\t\t\tfrom: \"donations\",\n\t\t\t\t\tlocalField: \"Page\",\n\t\t\t\t\tforeignField: \"_id\",\n\t\t\t\t\tas: \"Page\",\n\t\t\t\t\tpipeline: [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$lookup: {\n\t\t\t\t\t\t\t\tfrom: \"wishlists\",\n\t\t\t\t\t\t\t\tlocalField: \"_id\",\n\t\t\t\t\t\t\t\tforeignField: \"item\",\n\t\t\t\t\t\t\t\tas: \"favr\",\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$addFields: {\n\t\t\t\t\t\t\t\tfavr: {\n\t\t\t\t\t\t\t\t\t$cond: {\n\t\t\t\t\t\t\t\t\t\tif: {\n\t\t\t\t\t\t\t\t\t\t\t$in: [\n\t\t\t\t\t\t\t\t\t\t\t\treq.user?._id\n\t\t\t\t\t\t\t\t\t\t\t\t\t? new mongoose.Types.ObjectId(req.user._id)\n\t\t\t\t\t\t\t\t\t\t\t\t\t: null,\n\t\t\t\t\t\t\t\t\t\t\t\t\"$favr.user\",\n\t\t\t\t\t\t\t\t\t\t\t],\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\tthen: true,\n\t\t\t\t\t\t\t\t\t\telse: false,\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t],\n\t\t\t\t},\n\t\t\t},\n\t\t\t{\n\t\t\t\t$addFields: {\n\t\t\t\t\tPage: {\n\t\t\t\t\t\t$first: \"$Page\", // Use $Page to reference the array\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t]);\n\t\tres.status(200).json(\n\t\t\tnew ApiResponse(\n\t\t\t\t200,\n\n\t\t\t\tcontents[0],\n\n\t\t\t\t\"Donation Content fetched Successfully\"\n\t\t\t)\n\t\t);\n\t} catch (error) {\n\t\tres.status(500).json({ message: error.message });\n\t}\n});\n\nrouter.route(\"/contents/:langid\").get(getActiveContentsByLangId);\nrouter.route(\"/donation-history\").get(getUserInvoices);\nrouter.route(\"/donate/invoice\").post(makeDonationInvoice);\nrouter.route(\"/content/:id\").get(getDonationContent);\n\nmodule.exports = router;\n"],"mappings":"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","ignoreList":[]}